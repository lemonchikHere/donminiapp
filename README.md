# Don Estate Backend

Этот репозиторий содержит бэкенд-сервисы для **Don Estate** Telegram Mini App, платформы по недвижимости для агентства в Донецке. Система предназначена для парсинга объявлений о недвижимости из Telegram-канала, их обработки и сохранения в базе данных, а также предоставления комплексного API для фронтенд-клиента.

## Содержание

- [Возможности](#возможности)
- [Технологический стек](#технологический-стек)
- [Архитектура системы](#архитектура-системы)
- [Структура проекта](#структура-проекта)
- [Настройка и установка](#настройка-и-установка)
  - [Предварительные требования](#предварительные-требования)
  - [Конфигурация](#конфигурация)
  - [Запуск приложения](#запуск-приложения)
- [API Endpoints](#api-endpoints)
- [Запуск тестов](#запуск-тестов)

## Возможности

- **Парсер Telegram-канала**: Скрипт на основе Telethon, который автоматически парсит новые объявления о недвижимости из указанного Telegram-канала.
- **Извлечение данных**: Использует регулярные выражения для извлечения ключевых данных о недвижимости (цена, площадь, количество комнат и т.д.) из неструктурированного текста.
- **Геокодирование**: Интегрируется с Yandex Maps API для преобразования адресов недвижимости в географические координаты.
- **Векторные представления**: Генерирует векторные представления описаний недвижимости с помощью модели OpenAI `text-embedding-3-small` для семантического поиска.
- **Бэкенд на FastAPI**: Надежный асинхронный API, построенный на FastAPI, для предоставления данных фронтенду.
- **База данных**: Использует PostgreSQL с расширением `pgvector` для эффективных геопространственных и векторных запросов.
- **Docker-окружение**: Весь стек приложения контейнеризирован с помощью Docker и управляется через `docker-compose` для легкой настройки и развертывания.

## Технологический стек

- **Бэкенд**: Python, FastAPI
- **Парсер Telegram**: Telethon
- **База данных**: PostgreSQL, SQLAlchemy, pgvector
- **Векторные представления**: OpenAI API
- **Геокодирование**: Yandex Maps API
- **Контейнеризация**: Docker, Docker Compose
- **Тестирование**: Pytest

## Архитектура системы

Приложение состоит из трех основных сервисов, управляемых `docker-compose`:

1.  **Postgres (`postgres`)**: Сервис базы данных, использующий образ с предустановленным расширением `pgvector`.
2.  **Парсер (`parser`)**: Автономный Python-скрипт, который подключается к Telegram через Telethon, парсит сообщения и сохраняет их в базу данных.
3.  **API (`api`)**: Приложение FastAPI, которое предоставляет RESTful-эндпоинты для взаимодействия фронтенда с данными о недвижимости.

## Структура проекта

```
.
├── src/
│   ├── api/                # Код приложения FastAPI
│   │   ├── routes/         # Роутеры API
│   │   ├── dependencies.py # Зависимости FastAPI (например, аутентификация пользователя)
│   │   └── main.py         # Инициализация основного приложения FastAPI
│   ├── models/             # Модели SQLAlchemy ORM
│   ├── parser/             # Код парсера Telegram-канала
│   │   ├── data_extractor.py # Логика извлечения данных из текста
│   │   ├── media_handler.py  # Логика загрузки медиа
│   │   └── telegram_parser.py# Основной скрипт парсера
│   ├── services/           # Сервисы бизнес-логики (например, геокодирование)
│   ├── config.py           # Настройки конфигурации приложения
│   └── database.py         # Управление сессиями базы данных
├── tests/                  # Тесты Pytest для приложения
├── .env.example            # Пример файла переменных окружения
├── app.js                  # Фронтенд на JavaScript (React)
├── docker-compose.yml      # Конфигурация Docker Compose
├── index.html              # Точка входа для фронтенда
└── requirements.txt        # Зависимости Python
```

## Настройка и установка

### Предварительные требования

-   Установленные Docker и Docker Compose на вашем локальном компьютере.
-   Аккаунт Telegram с учетными данными API. Вы можете получить их на [my.telegram.org](https://my.telegram.org).

### Конфигурация

1.  **Скопируйте пример файла окружения**:
    ```bash
    cp .env.example .env
    ```

2.  **Отредактируйте файл `.env`** и укажите необходимые значения:
    -   `TELEGRAM_API_ID`, `TELEGRAM_API_HASH`, `TELEGRAM_PHONE`: Ваши учетные данные Telegram API.
    -   `TELEGRAM_CHANNEL`: Имя пользователя или ID канала для парсинга (например, `@donetsk_estate`).
    -   `DB_PASSWORD`: Надежный пароль для базы данных PostgreSQL.
    -   `OPENAI_API_KEY`: Ваш API-ключ от OpenAI.
    -   `YANDEX_API_KEY`: Ваш API-ключ для Yandex Maps Geocoding API.
    -   `ADMIN_CHAT_ID`: ID чата в Telegram для получения уведомлений администратора (например, о новых заявках на просмотр).

### Запуск приложения

1.  **Соберите и запустите сервисы** с помощью Docker Compose:
    ```bash
    docker-compose up --build
    ```
    Эта команда соберет образы для сервисов `parser` и `api` и запустит все контейнеры.

2.  **Первый запуск**: При первом запуске `parser` Telethon попросит вас ввести номер телефона, код, который вы получите в Telegram, и пароль двухфакторной аутентификации, если он у вас установлен. После аутентификации будет создан файл `.session`, чтобы вы оставались в системе.

API будет доступен по адресу `http://localhost:8000`.

## API Endpoints

Основные эндпоинты API документированы через Swagger UI, который доступен по адресу `http://localhost:8000/docs` при запущенном сервисе API.

-   `POST /api/search`: Поиск недвижимости с фильтрами и семантическим запросом.
-   `GET /api/properties/{property_id}`: Получение детальной информации о недвижимости.
-   `GET /api/properties/similar/{property_id}`: Поиск похожих объектов недвижимости.
-   `GET /api/favorites/`: Получение избранных объектов текущего пользователя.
-   `POST /api/favorites/`: Добавление объекта в избранное.
-   `DELETE /api/favorites/{property_id}`: Удаление объекта из избранного.
-   `POST /api/appointments/`: Создание заявки на просмотр.
-   `GET /api/map/properties`: Получение всех объектов с координатами для отображения на карте.

## Запуск тестов

Для запуска тестов вы можете выполнить `pytest` внутри запущенного контейнера `api`.

1.  Найдите ID контейнера для сервиса `api`:
    ```bash
    docker-compose ps
    ```

2.  Запустите pytest внутри контейнера:
    ```bash
    docker-compose exec api pytest
    ```
